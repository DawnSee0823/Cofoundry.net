angular.module("cms.users",["ngRoute","cms.shared"]).constant("_",window._).constant("users.modulePath","/Admin/Modules/Users/Js/");
angular.module("cms.users").config(["$routeProvider","shared.routingUtilities","users.modulePath",function(e,r,s){r.registerCrudRoutes(e,s,"User")}]);
angular.module("cms.users").factory("users.userService",["$http","shared.serviceBase","users.options",function(t,e,r){var u={},n=e+"users";function s(e){return n+"/"+e}function o(e){return(e=e||{}).userAreaCode=r.userAreaCode,e}return u.getAll=function(e){return e=o(e),t.get(n,{params:e})},u.getById=function(e){return t.get(s(e))},u.add=function(e){return(e=o(e)).generatePassword=!0,t.post(n,e)},u.update=function(e){return t.patch(s(e.userId),e)},u.resetPassword=function(e){return t.put(s(e)+"/reset-password")},u.updateVerificationStatus=function(e,r){return t.put(s(e)+"/verification-status",{userId:e,isVerified:r})},u.remove=function(e){return t.delete(s(e))},u}]);
angular.module("cms.users").controller("AddUserController",["$location","_","shared.stringUtilities","shared.LoadState","shared.roleService","users.userService","users.options",function(e,o,t,a,n,r,s){var l=this;function i(){l.globalLoadState.on(),r.add(l.command).then(c).finally(l.globalLoadState.off)}function d(){c()}function c(){e.path("/")}n.getSelectionList(s.userAreaCode).then(function(e){e&&(l.roles=e.items,1===e.items.length&&(l.command.roleId=e.items[0].roleId))}),l.command={},l.globalLoadState=new a,l.editMode=!1,l.userArea=s,l.save=i,l.cancel=d}]);
angular.module("cms.users").controller("UserDetailsController",["$routeParams","$location","$q","shared.LoadState","shared.modalDialogService","shared.permissionValidationService","shared.roleService","shared.currentUser","users.userService","users.options",function(t,e,n,a,o,r,s,i,u,l){var d=this,c=i.userId==t.id;function m(){d.editMode=!0,d.mainForm.formStatus.clear()}function f(){P(d.saveLoadState),u.update(d.command).then(g.bind(null,"Changes were saved successfully")).finally(U.bind(null,d.saveLoadState))}function h(){d.editMode=!1,d.command=L(),d.mainForm.formStatus.clear()}function S(){var e={title:"Reset Password",message:"Resetting a password will log the user out of all sessions and email them a new temporary password that needs to be changed at first login.<br><br>Do you want to continue?",okButtonTitle:"Yes, reset it",onOk:function(){return P(),u.resetPassword(d.user.userId).then(g.bind(null,"Password reset, notification sent.")).finally(U)}};o.confirm(e)}function w(){var e={title:"Delete User",message:"Are you sure you want to delete this user?",okButtonTitle:"Yes, delete it",onOk:function(){return P(),u.remove(d.user.userId).then(p).catch(U)}};o.confirm(e)}function g(e){return v().then(b).then(d.mainForm.formStatus.success.bind(null,e))}function v(){var e=t.id;return u.getById(e).then(function(e){d.user=e})}function b(){d.command=L(),d.editMode=!1}function L(){var e=_.pick(d.user,"userId","firstName","lastName","email","requirePasswordChange","isEmailConfirmed");return d.user.accountVerifiedDate&&(e.isAccountVerified=!0),d.user.role&&(e.roleId=d.user.role.roleId),e.username=d.userArea.useEmailAsUsername?null:d.user.username,e}function p(){e.path("")}function P(e){d.globalLoadState.on(),e&&_.isFunction(e.on)&&e.on()}function U(e){d.globalLoadState.off(),e&&_.isFunction(e.off)&&e.off()}!function(){d.edit=m,d.save=f,d.cancel=h,d.resetPassword=S,d.deleteUser=w,d.editMode=!1,d.globalLoadState=new a,d.saveLoadState=new a,d.formLoadState=new a(!0);var e="COF"===(d.userArea=l).userAreaCode?"COFUSR":"COFUSN";d.canUpdate=r.canUpdate(e),d.canDelete=r.canDelete(e),d.canResetPassword=r.hasPermission(e+"RSTPWD")&&l.allowPasswordLogin&&l.useEmailAsUsername&&!c,n.all([s.getSelectionList(l.userAreaCode).then(function(e){e&&(d.roles=e.items)}),v()]).then(b).then(U.bind(null,d.formLoadState))}()}]);
angular.module("cms.users").controller("UserListController",["_","shared.LoadState","shared.SearchQuery","shared.urlLibrary","shared.permissionValidationService","users.userService","users.options",function(r,a,t,i,n,e,s){var o=this;function u(e){o.isFilterVisible=r.isUndefined(e)?!o.isFilterVisible:e}function d(){u(!1),l()}function l(){return o.gridLoadState.on(),e.getAll(o.query.getParameters()).then(function(e){o.result=e,o.gridLoadState.off()})}!function(){o.userArea=s,o.urlLibrary=i,o.gridLoadState=new a,o.query=new t({onChanged:d}),o.filter=o.query.getFilters(),o.toggleFilter=u;var e="COF"===s.userAreaCode?"COFUSR":"COFUSN";o.canRead=n.canRead(e),o.canUpdate=n.canUpdate(e),o.canCreate=n.canCreate(e),u(!1),l()}()}]);