angular.module("cms.customEntities",["ngRoute","cms.shared"]).constant("_",window._).constant("customEntities.modulePath","/Admin/Modules/CustomEntities/Js/"),angular.module("cms.customEntities").config(["$routeProvider","shared.routingUtilities","customEntities.modulePath",function(t,e,o){e.registerCrudRoutes(t,o,"CustomEntity")}]),angular.module("cms.customEntities").controller("ChangeOrderingController",["$scope","$q","$location","_","shared.LoadState","shared.arrayUtilities","shared.internalModulePath","shared.modalDialogService","shared.customEntityService","customEntities.options","options","close",function(o,t,e,n,i,a,s,l,r,u,d,c){var m="customEntityId";function f(){o.command.orderedCustomEntityIds=E(),o.submitLoadState.on(),r.updateOrdering(o.command).then(d.onSave).then(c).finally(o.submitLoadState.off)}function h(){o.formLoadState.off()}function g(t,e){a.moveObject(o.gridData,e,t,m)}function y(t){a.removeObject(o.gridData,t)}function S(){l.show({templateUrl:s+"UIComponents/CustomEntities/CustomEntityPickerDialog.html",controller:"CustomEntityPickerDialogController",options:{selectedIds:E(),customEntityDefinition:u,filter:{localeId:o.command.localeId},onSelected:function(e){{var t;e&&e.length?(t=n.filter(o.gridData,function(t){return!n.contains(e,t[m])}),o.gridData=n.difference(o.gridData,t),(t=n.difference(e,E())).length&&(o.gridLoadState.on(),r.getByIdRange(t).then(function(t){o.gridData=n.union(o.gridData,t),o.gridLoadState.off()}))):o.gridData=[]}}}})}function E(){return n.pluck(o.gridData,m)}function v(t){2===(o.currentStep=t)&&function(){o.formLoadState.on();var t={pageSize:60,localeId:o.command.localeId,interpretNullLocaleAsNone:!0};r.getAll(t,u.customEntityDefinitionCode).then(function(t){o.isPartialOrdering?o.gridData=n.filter(t.items,function(t){return!!t.ordering}):o.gridData=t.items,o.formLoadState.off()})}()}o.options=u,o.command={localeId:d.localeId,customEntityDefinitionCode:u.customEntityDefinitionCode},o.isPartialOrdering="Partial"===u.ordering,o.submitLoadState=new i,o.formLoadState=new i(!0),o.gridLoadState=new i,o.save=f,o.close=c,o.setStep=v,o.onLocalesLoaded=h,o.onDrop=g,o.remove=y,o.showPicker=S,u.hasLocale?(o.allowStep1=!0,v(1)):(v(2),o.formLoadState.off())}]),angular.module("cms.customEntities").controller("ChangeUrlController",["$scope","$q","$location","shared.LoadState","shared.customEntityService","customEntities.options","options","close",function(t,e,o,n,i,a,s,l){var r,u=e.defer();function d(){t.submitLoadState.on(),i.updateUrl(t.command).then(s.onSave).then(l).finally(t.submitLoadState.off)}r=s.customEntity,t.options=a,t.customEntity=r,t.command={customEntityId:r.customEntityId,localeId:r.locale?r.locale.localeId:void 0,urlSlug:r.urlSlug},t.submitLoadState=new n,t.formLoadState=new n(a.hasLocale),t.save=d,t.close=l,t.localesLoaded=u.resolve,t.formLoadState.offWhen(u)}]),angular.module("cms.customEntities").controller("DuplicateCustomEntityController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.customEntityService","customEntities.options","options","close",function(e,t,o,n,i,a,s,l,r){var u=t.defer();function d(){e.command.urlSlug=n.slugify(e.command.title)}function c(){e.submitLoadState.on(),a.duplicate(e.command).then(m).then(r).finally(e.submitLoadState.off)}function m(t){o.path("/"+t)}(function(){var t=l.customEntity;e.customEntity=t,e.command={customEntityToDuplicateId:t.customEntityId,localeId:t.locale?t.locale.localeId:void 0,title:"Copy of "+t.latestVersion.title},d()})(),e.submitLoadState=new i,e.formLoadState=new i(s.hasLocale),e.customEntityDefinition=s,e.save=c,e.close=r,e.onTitleChanged=d,e.localesLoaded=u.resolve,e.formLoadState.offWhen(u)}]),angular.module("cms.customEntities").controller("AddCustomEntityController",["$scope","$location","$q","$window","shared.stringUtilities","shared.LoadState","shared.customEntityService","shared.urlLibrary","customEntities.options",function(o,e,t,n,i,a,s,l,r){var u=this;function d(t,e){var o=t?(u.command.publish=!0,u.saveAndPublishLoadState):u.saveLoadState;t=o,u.globalLoadState.on(),t&&_.isFunction(t.on)&&t.on(),s.add(u.command,r.customEntityDefinitionCode).then(e).finally(function(t){u.globalLoadState.off(),t&&_.isFunction(t.off)&&t.off()}.bind(null,o))}function c(){u.command.urlSlug=i.slugify(u.command.title)}function m(){e.path("/")}function f(t){e.path("/"+t)}function h(e){return s.getById(e).then(function(t){t=l.customEntityVisualEditor(t,!0);t?n.location.href=t:f(e)})}u.globalLoadState=new a,u.saveLoadState=new a,u.saveAndPublishLoadState=new a,u.formLoadState=new a(!0),u.editMode=!1,u.options=r,u.saveButtonText=r.autoPublish?"Save":"Save & Publish",u.saveAndEditButtonText=r.autoPublish?"Save & Edit Content":"Save Draft & Edit Content",u.save=d.bind(null,!1,f),u.saveAndPublish=d.bind(null,!0,f),u.saveAndEdit=d.bind(null,!1,h),u.cancel=m,u.onNameChanged=c,function(){u.command={};var t=s.getDataModelSchema(r.customEntityDefinitionCode).then(function(t){t.defaultValue&&t.defaultValue.value?u.command.model=angular.copy(t.defaultValue.value):u.command.model={};u.formDataSource={model:u.command.model,modelMetaData:t}}),e=s.getPageRoutes(r.customEntityDefinitionCode).then(function(t){u.pageRoutes=t});u.formLoadState.offWhen(t,e),o.$watch("vm.command.localeId",function(t){u.additionalParameters=t?{localeId:t}:{}})}()}]),angular.module("cms.customEntities").controller("CustomEntityDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.customEntityService","shared.urlLibrary","shared.permissionValidationService","customEntities.modulePath","customEntities.options",function(e,o,t,n,i,a,s,l,r,u,d,c,m){var f,h=this,g=m.nameSingular.toLowerCase(),y={entityNameSingular:m.nameSingular,isCustomEntity:!0};function S(){h.editMode=!0,h.mainForm.formStatus.clear()}function E(t){t=t?(h.updateCommand.publish=!0,h.saveAndPublishLoadState):h.saveLoadState;k(t),r.updateDraft(h.updateCommand,m.customEntityDefinitionCode).then(U.bind(null,"Changes were saved successfully")).finally(R.bind(null,t))}function v(){h.editMode=!1,h.updateCommand=A(h.customEntity),h.mainForm.formStatus.clear()}function p(){l.publish(h.customEntity.customEntityId,k,y).then(U.bind(null,m.nameSingular+" published successfully.")).catch(R)}function b(){l.unpublish(h.customEntity.customEntityId,k,y).then(U.bind(null,"The "+g+" has been unpublished and reverted to draft state.")).catch(R)}function C(){var t={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since it was last published.",okButtonTitle:"Yes, discard it",onOk:function(){return k(),r.removeDraft(h.customEntity.customEntityId)}};s.confirm(t).then(U.bind(null,"Draft discarded successfully"))}function L(t){l.copyToDraft(h.customEntity.customEntityId,t.customEntityVersionId,h.customEntity.hasDraftVersion,k,y).then(function(){U("Draft created successfully.")}).catch(R)}function D(){s.show({templateUrl:c+"Routes/Modals/DuplicateCustomEntity.html",controller:"DuplicateCustomEntityController",options:{customEntity:h.customEntity}})}function w(){var t={title:"Delete "+m.nameSingular,message:"Are you sure you want to delete this "+g+"?",okButtonTitle:"Yes, delete it",onOk:function(){return k(),r.remove(h.customEntity.customEntityId).then(T).catch(R)}};s.confirm(t)}function P(){s.show({templateUrl:c+"Routes/Modals/ChangeUrl.html",controller:"ChangeUrlController",options:{customEntity:h.customEntity,onSave:U.bind(null,"Url Changed")}})}function I(t){return d.hasPermission(m.customEntityDefinitionCode+t)}function U(t,e){return M(e).then(h.mainForm.formStatus.success.bind(null,t))}function M(t){return o.all([r.getById(e.id),F(),r.getDataModelSchema(m.customEntityDefinitionCode)]).then(function(t){var e=t[0],o=t[1];f=t[2],$(h.customEntity=e,o),h.updateCommand=A(e),h.isMarkedPublished="Published"==h.customEntity.publishStatus,h.publishStatusLabel=O(e),h.customEntity.locale?h.additionalParameters={localeId:h.customEntity.locale.localeId}:h.additionalParameters={};h.editMode=!1}).then(R.bind(null,t))}function V(){return h.versionsLoadState.on(),F().then(function(t){$(h.customEntity,t)}).then(R.bind(null,h.versionsLoadState))}function F(){return r.getVersionsByCustomEntityId(e.id,h.versionsQuery.getParameters())}function $(e,t){e.latestVersion.pages[0];var o=e.isPublished();n.each(t.items,function(t){t.versionLabel=function(t,e){if("Draft"==t.workFlowStatus)return t.workFlowStatus;var o="V"+t.displayVersion;return t.isLatestPublishedVersion?o+" ("+O(e)+")":o}(t,e),t.browseUrl=h.urlLibrary.visualEditorForVersion(e,t,!0,o)}),h.versions=t}function O(t){return"Published"==t.publishStatus&&t.publishDate<Date.now()?"Pending Publish":t.publishStatus}function A(t){t={customEntityId:t.customEntityId,title:t.latestVersion.title,model:angular.copy(t.latestVersion.model)};return h.formDataSource={model:t.model,modelMetaData:f},t}function T(){t.path("")}function k(t){h.globalLoadState.on(),t&&n.isFunction(t.on)&&t.on()}function R(t){h.globalLoadState.off(),t&&n.isFunction(t.off)&&t.off()}h.edit=S,h.save=E.bind(null,!1),h.saveAndPublish=E.bind(null,!0),h.cancel=v,h.publish=p,h.unpublish=b,h.discardDraft=C,h.copyToDraft=L,h.duplicate=D,h.deleteCustomEntity=w,h.changeUrl=P,h.editMode=!1,h.globalLoadState=new i,h.saveLoadState=new i,h.saveAndPublishLoadState=new i,h.formLoadState=new i(!0),h.versionsLoadState=new i,h.options=m,h.urlLibrary=u,h.saveButtonText=m.autoPublish?"Save":"Save & Publish",h.canChangeUrl=!m.autoGenerateUrlSlug||m.hasLocale,h.versionsQuery=new a({onChanged:V,useHistory:!1,defaultParams:{pageSize:6}}),h.canPublish=I("CMEPUB"),h.canUpdateUrl=I("UPDURL"),h.canDelete=I("COMDEL"),h.canUpdate=I("COMUPD"),h.canCreate=I("COMCRT"),M(h.formLoadState)}]),angular.module("cms.customEntities").controller("CustomEntityListController",["$q","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.customEntityService","shared.permissionValidationService","shared.ModelPreviewFieldset","shared.ImagePreviewFieldCollection","customEntities.modulePath","customEntities.options",function(o,e,t,n,i,a,s,l,r,u,d){var c=this;function m(t){c.isFilterVisible=e.isUndefined(t)?!c.isFilterVisible:t}function f(){i.show({templateUrl:u+"Routes/Modals/ChangeOrdering.html",controller:"ChangeOrderingController",options:{localeId:c.filter.localeId,onSave:y}})}function h(){m(!1),y()}function g(t){return s.hasPermission(d.customEntityDefinitionCode+t)}function y(){var t,e=(c.gridLoadState.on(),a.getAll(c.query.getParameters(),d.customEntityDefinitionCode).then(function(t){c.result=t,c.gridLoadState.off()}));return c.previewFields?(t=o.defer()).resolve():t=a.getDataModelSchema(d.customEntityDefinitionCode).then(function(t){c.previewFields=new l(t)}),o.all([t,e]).then(function(){return c.gridImages=new r,c.gridImages.load(c.result.items,c.previewFields)})}c.options=d,c.gridLoadState=new t,c.query=new n({onChanged:h}),c.filter=c.query.getFilters(),c.toggleFilter=m,c.changeOrdering=f,c.permissions=s,c.canUpdate=g("COMUPD"),c.canCreate=g("COMCRT"),m(!1),y()}]);