angular.module("cms.visualEditor",["cms.shared"]).constant("_",window._).constant("visualEditor.modulePath","/Admin/Modules/VisualEditor/Js/"),angular.module("cms.visualEditor").factory("visualEditor.pageBlockService",["$http","shared.serviceBase","visualEditor.options",function(n,o,t){var e={},a=o+"page-version-region-blocks",i=o+"custom-entity-version-page-blocks";function l(e,o){return d(e)+"/"+o}function d(e){return e?i:a}return e.getAllBlockTypes=function(){return n.get(o+"page-block-types/")},e.getPageVersionBlockById=function(e,o){return n.get(l(e,o)+"?datatype=updatecommand")},e.getRegion=function(e){return n.get(o+"page-templates/0/regions/"+e)},e.getBlockTypeSchema=function(e){return n.get(o+"page-block-types/"+e)},e.add=function(e,o){return o[(e?"customEntity":"page")+"VersionId"]=t.versionId,n.post(d(e),o)},e.update=function(e,o,t){return n.put(l(e,o),t)},e.remove=function(e,o){return n.delete(l(e,o))},e.moveUp=function(e,o){return n.put(l(e,o)+"/move-up")},e.moveDown=function(e,o){return n.put(l(e,o)+"/move-down")},e}]),angular.module("cms.visualEditor").controller("AddBlockController",["$scope","$q","_","shared.LoadState","visualEditor.pageBlockService","visualEditor.options","options","close",function(o,e,t,n,a,i,l,d){function c(){o.submitLoadState.on(),a.add(l.isCustomEntity,o.command).then(l.refreshContent).then(r).finally(o.submitLoadState.off)}function r(){d(),l.onClose()}function s(e){2===(o.currentStep=e)&&(o.formLoadState.on(),a.getBlockTypeSchema(o.command.pageBlockTypeId).then(function(e){e.defaultValue&&e.defaultValue.value&&t.defaults(o.command.dataModel,angular.copy(e.defaultValue.value)),o.formDataSource={modelMetaData:e,model:o.command.dataModel},o.templates=e.templates,o.formLoadState.off()}))}function u(e){o.command.pageBlockTypeId=e&&e.pageBlockTypeId}function p(e){u(e),s(2)}function m(e){return e&&e.pageBlockTypeId===o.command.pageBlockTypeId}l.anchorElement,o.command={dataModel:{},pageId:l.pageId,pageTemplateRegionId:l.pageTemplateRegionId,pageVersionId:i.pageVerisonId,adjacentVersionBlockId:l.adjacentVersionBlockId,insertMode:l.insertMode||"Last"},o.submitLoadState=new n,o.formLoadState=new n(!0),o.save=c,o.close=r,o.selectBlockType=u,o.selectBlockTypeAndNext=p,o.isBlockTypeSelected=m,o.setStep=s,s(1),a.getAllBlockTypes().then(function(e){o.title=l.regionName,l.permittedBlockTypes.length?o.blockTypes=t.filter(e,function(e){return t.contains(l.permittedBlockTypes,e.fileName)}):o.blockTypes=e,1===o.blockTypes.length?(o.command.pageBlockTypeId=o.blockTypes[0].pageBlockTypeId,s(2)):o.allowStep1=!0,o.formLoadState.off()})}]),angular.module("cms.visualEditor").controller("EditBlockController",["$scope","$q","_","shared.LoadState","visualEditor.pageBlockService","visualEditor.options","options","close",function(n,a,e,o,i,t,l,d){function c(){n.submitLoadState.on(),i.update(l.isCustomEntity,l.versionBlockId,n.command).then(l.refreshContent).then(r).finally(n.submitLoadState.off)}function r(){d(),l.onClose()}l.anchorElement,n.command={dataModel:{},pageId:l.pageId},n.submitLoadState=new o,n.formLoadState=new o(!0),n.save=c,n.close=r,function(){var e,o,t={};n.formLoadState.on(),e=i.getBlockTypeSchema(l.pageBlockTypeId).then(function(e){n.templates=e.templates,t.modelMetaData=e}),o=i.getPageVersionBlockById(l.isCustomEntity,l.versionBlockId).then(function(e){n.command=e,t.model=e.dataModel}),a.all([e,o]).then(function(){n.formDataSource=t,n.formLoadState.off()})}()}]),angular.module("cms.visualEditor").controller("VisualEditorController",["$window","$scope","_","shared.LoadState","shared.entityVersionModalDialogService","shared.modalDialogService","shared.localStorage","visualEditor.pageBlockService","visualEditor.modulePath","shared.urlLibrary","visualEditor.options",function(o,e,i,t,n,a,l,d,c,r,s){var u,p,m=this,f=(o.document,new t);function g(e){e.data.action&&m[e.data.action]&&m[e.data.action].apply(this,e.data.args)}function k(){u={entityNameSingular:s.entityNameSingular,isCustomEntity:s.isCustomEntityRoute}}function y(e){n.publish(e.entityId,b,u).then(L).catch(w)}function B(e){n.unpublish(e.entityId,b,u).then(L).catch(w)}function h(e){n.copyToDraft(e.entityId,e.versionId,e.hasDraftVersion,b,u).then(L).catch(w)}function v(e){a.show({templateUrl:c+"Routes/Modals/AddBlock.html",controller:"AddBlockController",options:{insertMode:e.insertMode,pageTemplateRegionId:e.pageTemplateRegionId,adjacentVersionBlockId:e.versionBlockId,permittedBlockTypes:e.permittedBlockTypes,isCustomEntity:e.isCustomEntity,regionName:e.regionName,pageId:e.pageId,onClose:function(){f.off()},refreshContent:C}})}function I(e){f.isLoading||(f.on(),a.show({templateUrl:c+"Routes/Modals/AddBlock.html",controller:"AddBlockController",options:{pageTemplateRegionId:e.pageTemplateRegionId,adjacentVersionBlockId:e.versionBlockId,permittedBlockTypes:e.permittedBlockTypes,insertMode:e.insertMode,refreshContent:C,isCustomEntity:e.isCustomEntity,pageId:e.pageId,onClose:function(){f.off()}}}))}function E(e){f.isLoading||(f.on(),a.show({templateUrl:c+"Routes/Modals/EditBlock.html",controller:"EditBlockController",options:{versionBlockId:e.versionBlockId,pageBlockTypeId:e.pageBlockTypeId,isCustomEntity:e.isCustomEntity,refreshContent:C,onClose:function(){f.off()}}}))}function S(e){var o=e.isUp?d.moveUp:d.moveDown;f.isLoading||(f.on(),o(e.isCustomEntity,e.versionBlockId).then(C).finally(f.off))}function T(e){var o=e.isCustomEntity,t={title:"Delete Block",message:"Are you sure you want to delete this content block?",okButtonTitle:"Yes, delete it",onOk:function(){return d.remove(o,e.versionBlockId).then(C).finally(f.off)},onCancel:function(){f.off()}};f.isLoading||(f.on(),a.confirm(t))}function C(){o.parent.location=o.parent.location}function L(){var e=function(e,t){var o=e.match(/(.+)(?:\?)([^#\s]*)(#.*|)/i),n=[],a="";if(!o)return e;i.each(o[2].split("&"),function(o){o&&i.every(t,function(e){return-1===o.indexOf(e+"=")})&&n.push(o)}),n.length&&(a="?"+n.join("&"));return e=o[1]+a+o[3]}(o.parent.location.href,["version","mode"]);o.parent.location=e}function b(e){m.globalLoadState.on()}function w(e){m.globalLoadState.off()}p=o.addEventListener?"addEventListener":"attachEvent",(0,window[p])("attachEvent"==p?"onmessage":"message",g),m.globalLoadState=f,m.config=k,m.publish=y,m.unpublish=B,m.copyToDraft=h,m.addRegionBlock=v,m.addBlock=I,m.addBlockAbove=I,m.addBlockBelow=I,m.editBlock=E,m.moveBlockUp=S,m.moveBlockDown=S,m.deleteBlock=T}]);