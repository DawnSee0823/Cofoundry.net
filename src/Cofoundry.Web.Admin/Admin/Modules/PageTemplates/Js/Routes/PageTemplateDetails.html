<cms-page-header cms-title="{{vm.pageTemplate.name}}"
                 cms-parent-title="Page Templates"></cms-page-header>

<cms-form cms-name="mainForm"
          cms-edit-mode="vm.editMode"
          ng-submit="vm.save()"
          cms-loading="vm.formLoadState.isLoading">

    <!-- Default toolbar -->
    <cms-page-actions ng-if="!vm.editMode">

        <cms-button class="main-cta"
                    cms-text="Edit"
                    ng-click="vm.edit()"
                    ng-show="!vm.editMode"
                    ng-disabled="vm.globalLoadState.isLoading"></cms-button>

        <cms-button cms-text="Re-scan File"
                    ng-click="vm.rescanFile()"
                    ng-disabled="vm.editMode || vm.globalLoadState.isLoading"
                    title="Re-scan the template file for updates."></cms-button>

        <cms-button cms-text="Delete"
                    ng-click="vm.deleteLayout()"
                    ng-disabled="vm.pageTemplate.numPages || vm.editMode || vm.globalLoadState.isLoading"
                    title="{{vm.deleteTitle}}"></cms-button>

    </cms-page-actions>

    <!-- Edit toolbar -->
    <cms-page-actions ng-if="vm.editMode">

        <cms-button-submit cms-text="Save"
                           ng-show="vm.editMode"
                           ng-disabled="vm.mainForm.$invalid || vm.globalLoadState.isLoading"
                           cms-loading="vm.saveLoadState.isLoading"></cms-button-submit>

        <cms-button cms-text="Cancel"
                    ng-click="vm.cancel()"
                    ng-show="vm.editMode"
                    ng-disabled="vm.globalLoadState.isLoading"></cms-button>

    </cms-page-actions>

    <!-- Scrollable content area -->
    <cms-page-body cms-content-type="form">

        <cms-form-status></cms-form-status>

        <!--MAIN-->
        <cms-form-section cms-title="Main">

            <cms-form-field-text cms-title="Name"
                                 cms-model="vm.command.name"
                                 maxlength="100"
                                 required></cms-form-field-text>

            <cms-form-field-text-area cms-title="Description"
                                      cms-model="vm.command.description"></cms-form-field-text-area>

            <cms-form-field-readonly cms-title="File path"
                                     cms-model="vm.pageTemplate.fullPath"></cms-form-field-readonly>

            <cms-form-field-container cms-title="Page Type">
                <span>{{vm.pageTemplate.pageType == 'CustomEntityDetails' ? vm.pageTemplate.customEntityDefinition.name + ' Details' : vm.pageTemplate.pageType}}</span>
            </cms-form-field-container>

            <cms-form-field-readonly cms-title="Model Type"
                                     cms-model="vm.pageTemplate.customEntityModelType"
                                     ng-if="vm.pageTemplate.pageType == 'CustomEntityDetails'"></cms-form-field-readonly>

            <cms-form-field-container cms-title="Num Pages">
                <a ng-href="/admin/pages#/?webDirectoryId={{::vm.pageTemplate.pageTemplateId}}">{{::vm.pageTemplate.numPages}}</a>
            </cms-form-field-container>

        </cms-form-section>

        <!--SECTIONS-->

        <cms-form-section cms-title="Sections">

            <div class="control-group">
                <div class="control-group-area">
                    <cms-table-container>
                        <table>
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th ng-if="vm.pageTemplate.customEntityDefinition">Entity</th>
                                    <th>Allowed Modules</th>
                                    <th cms-table-column-actions style="width: 150px;"  ng-if="!vm.editMode">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr ng-if="!vm.pageTemplate.sections.length">
                                    <td colspan="100" class="empty">None.</td>
                                </tr>
                                <tr ng-repeat="section in vm.pageTemplate.sections">
                                    <td>{{::section.name}}</td>
                                    <td ng-if="vm.pageTemplate.customEntityDefinition">
                                        <span ng-if="::section.isCustomEntitySection">{{::vm.pageTemplate.customEntityDefinition.name}}</span>
                                        <span ng-if="::!section.isCustomEntitySection">Page</span>
                                    </td>
                                    <td>
                                        <span ng-repeat-start="moduleType in ::section.moduleTypes"
                                              ng-if="::!section.hasAllModuleTypes"
                                              title="{{::moduleType.description}}"
                                              ng-bind="::moduleType.name">
                                        </span><span ng-repeat-end ng-if="!$last && !section.hasAllModuleTypes">, </span>

                                        <span ng-if="::section.hasAllModuleTypes">
                                            Any Generic
                                        </span>
                                    </td>
                                    <td cms-table-column-actions ng-if="!vm.editMode">
                                        <a href=""
                                           ng-click="vm.editModuleTypes(section)"
                                           ng-if="!vm.globalLoadState.isLoading" class="btn-icon" title="Edit modules">
                                            <i class="fa fa-pencil"></i>
                                        </a>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </cms-table-container>
                </div>

            </div>

        </cms-form-section>

        <!--AUDIT DATA-->
        <cms-form-section-audit-data cms-audit-data="vm.pageTemplate.auditData"></cms-form-section-audit-data>

    </cms-page-body>

</cms-form>