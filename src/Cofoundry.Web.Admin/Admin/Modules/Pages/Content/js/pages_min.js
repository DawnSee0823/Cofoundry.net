angular.module("cms.pages",["ngRoute","cms.shared"]).constant("_",window._).constant("pages.modulePath","/Admin/Modules/Pages/Js/"),angular.module("cms.pages").config(["$routeProvider","shared.routingUtilities","pages.modulePath",function(e,t,a){a=t.mapOptions.bind(null,a);e.when("/new",a("AddPage")).when("/:id",a("PageDetails")).otherwise(a("PageList"))}]),angular.module("cms.pages").factory("pages.customEntityService",["$http","shared.serviceBase",function(e,t){var a={getAllRoutingRules:function(){return e.get(t+"custom-entity-routing-rules/")}};return a}]),angular.module("cms.pages").factory("pages.directoryService",["$http","_","shared.serviceBase",function(e,t,a){var n={},o=a+"page-directories";return n.getAll=function(){return e.get(o)},n}]),angular.module("cms.pages").factory("pages.pageTemplateService",["$http","$q","shared.serviceBase",function(e,a,t){var n={},o=t+"page-templates";return n.getAll=function(){var t=a.defer();return e.get(o).then(function(e){t.resolve(e.items)},t.reject),t.promise},n}]),angular.module("cms.pages").controller("ChangePageUrlController",["$scope","$q","$location","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(a,t,e,n,o,i,r,s){var l=t.defer(),u=t.defer();function d(){a.submitLoadState.on(),o.updateUrl(a.command).then(r.onSave).then(s).finally(a.submitLoadState.off)}(function(){var e=r.page,t=e.pageRoute;a.isCustomEntityRoute="CustomEntityDetails"===t.pageType,a.page=e,a.command={pageId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId},a.isCustomEntityRoute?a.command.customEntityRoutingRule=t.urlPath:a.command.urlPath=t.urlPath})(),a.submitLoadState=new n,a.formLoadState=new n(!0),a.save=d,a.close=s,a.localesLoaded=l.resolve,a.pageDirectoriesLoaded=u.resolve,a.formLoadState.offWhen(l,u,function(){if(a.isCustomEntityRoute)return i.getAllRoutingRules().then(function(e){a.routingRules=e});var e=t.defer();return e.resolve(),e}())}]),angular.module("cms.pages").controller("DuplicatePageController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(a,t,n,e,o,i,r,s,l){var u=t.defer(),d=t.defer();function c(){a.isCustomEntityRoute||(a.command.urlPath=e.slugify(a.command.title))}function g(){a.submitLoadState.on(),i.duplicate(a.command).then(p).then(l).finally(a.submitLoadState.off)}function p(e){n.path("/"+e)}(function(){var e=s.page,t=e.pageRoute;a.isCustomEntityRoute="CustomEntityDetails"===t.pageType,a.page=e,a.command={pageToDuplicateId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId,title:"Copy of "+e.latestVersion.title},a.isCustomEntityRoute?a.command.customEntityRoutingRule=t.urlPath:c()})(),a.submitLoadState=new o,a.formLoadState=new o(!0),a.save=g,a.close=l,a.onTitleChanged=c,a.localesLoaded=u.resolve,a.pageDirectoriesLoaded=d.resolve,a.formLoadState.offWhen(u,d,function(){if(a.isCustomEntityRoute)return r.getAllRoutingRules().then(function(e){a.routingRules=e});var e=t.defer();return e.resolve(),e}())}]),angular.module("cms.pages").controller("AddPageController",["_","$q","$location","$window","shared.LoadState","shared.stringUtilities","shared.urlLibrary","shared.pageService","pages.pageTemplateService","pages.customEntityService",function(n,e,t,a,o,i,r,s,l,u){var d=this,c=e.defer(),g=e.defer();function p(e,t){var a=e?(d.command.publish=!0,d.saveAndPublishLoadState):d.saveLoadState;e=a,d.globalLoadState.on(),e&&n.isFunction(e.on)&&e.on(),s.add(d.command).then(t).finally(function(e){d.globalLoadState.off(),e&&n.isFunction(e.off)&&e.off()}.bind(null,a))}function f(e){t.path("/"+e)}function h(e){return s.getById(e).then(function(e){a.location.href=r.visualEditorForPage(e.pageRoute,!0)})}function m(){d.command.urlPath=i.slugify(d.command.title)}function v(){var e=d.command.pageType,e="CustomEntityDetails"==e?e:"Generic";d.pageTemplates=n.where(d.allPageTemplates,{pageType:e})}function S(){t.path("/")}d.save=p.bind(null,!1,f),d.saveAndPublish=p.bind(null,!0,f),d.saveAndEdit=p.bind(null,!1,h),d.cancel=S,d.onNameChanged=m,d.onPageTypeChanged=v,d.globalLoadState=new o,d.saveLoadState=new o,d.saveAndPublishLoadState=new o,d.formLoadState=new o(!0),d.onLocalesLoaded=c.resolve,d.onPageDirectoriesLoaded=g.resolve,function(){d.pageTypes=s.getPageTypes(),d.command={showInSiteMap:!0,pageType:d.pageTypes[0].value};var e=l.getAll().then(function(e){d.allPageTemplates=e}),t=u.getAllRoutingRules().then(function(e){d.routingRules=e});d.formLoadState.offWhen(c,g,e,t).then(v)}()}]),angular.module("cms.pages").controller("PageDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.urlLibrary","shared.pageService","shared.permissionValidationService","pages.modulePath",function(t,a,e,n,o,i,r,s,l,u,d,c){var g=this;function p(){g.editMode=!0,g.mainForm.formStatus.clear()}function f(e){e=e?(g.updateDraftCommand.publish=!0,g.saveAndPublishLoadState):g.saveLoadState;F(e),u.update(g.updatePageCommand).then(u.updateDraft.bind(this,g.updateDraftCommand)).then(C.bind(null,"Changes were saved successfully")).finally($.bind(null,e))}function h(){g.editMode=!1,g.updatePageCommand=T(g.page),g.updateDraftCommand=A(g.page),g.mainForm.formStatus.clear()}function m(){s.publish(g.page.pageId,F).then(C.bind(null,"Page published successfully.")).catch($)}function v(){s.unpublish(g.page.pageId,F).then(C.bind(null,"The page has been unpublished and reverted to draft state.")).catch($)}function S(){var e={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since the page was last published.",okButtonTitle:"Yes, discard it",onOk:function(){return F(),u.removeDraft(g.page.pageId)}};r.confirm(e).then(C.bind(null,"Draft discarded successfully"))}function b(e){s.copyToDraft(g.page.pageId,e.pageVersionId,g.page.pageRoute.hasDraftVersion,F).then(function(){C("Draft created successfully.")}).catch($)}function y(){var e={title:"Delete Page",message:"Are you sure you want to delete this page?",okButtonTitle:"Yes, delete it",onOk:function(){return F(),u.remove(g.page.pageId).then(U).catch($)}};r.confirm(e)}function P(){r.show({templateUrl:c+"Routes/Modals/DuplicatePage.html",controller:"DuplicatePageController",options:{page:g.page}})}function L(){r.show({templateUrl:c+"Routes/Modals/ChangePageUrl.html",controller:"ChangePageUrlController",options:{page:g.page,onSave:C.bind(null,"Url Changed")}})}function C(e,t){return D(t).then(g.mainForm.formStatus.success.bind(null,e))}function D(e){return a.all([u.getById(t.id).then(function(e){return g.page=e,g.updatePageCommand=T(e),g.updateDraftCommand=A(e),g.editMode=!1,g.isMarkedPublished="Published"==g.page.pageRoute.publishStatus,g.publishStatusLabel=E(e.pageRoute),e}),R()]).then(function(e){I(e[1])}).then($.bind(null,e))}function w(){return g.versionsLoadState.on(),R().then(I).then($.bind(null,g.versionsLoadState))}function R(){return u.getVersionsByPageId(t.id,g.versionsQuery.getParameters())}function I(e){var t=g.page,a=t.pageRoute.isPublished();n.each(e.items,function(e){e.versionLabel=function(e,t){if("Draft"==e.workFlowStatus)return e.workFlowStatus;var a="V"+e.displayVersion;return e.isLatestPublishedVersion?a+" ("+E(t)+")":a}(e,t.pageRoute),e.browseUrl=g.urlLibrary.visualEditorForVersion(t.pageRoute,e,!1,a)}),g.versions=e}function E(e){return"Published"==e.publishStatus&&e.publishDate<Date.now()?"Pending Publish":e.publishStatus}function T(e){return{pageId:e.pageId,tags:e.tags}}function A(e){var t=e.latestVersion,a=t.openGraph;return{pageId:e.pageId,title:t.title,metaDescription:t.metaDescription,openGraphTitle:a.title,openGraphDescription:a.description,openGraphImageId:a.image?a.image.ImageAssetId:void 0,showInSiteMap:t.showInSiteMap}}function U(){e.path("")}function F(e){g.globalLoadState.on(),e&&n.isFunction(e.on)&&e.on()}function $(e){g.globalLoadState.off(),e&&n.isFunction(e.off)&&e.off()}g.edit=p,g.save=f.bind(null,!1),g.saveAndPublish=f.bind(null,!0),g.cancel=h,g.publish=m,g.unpublish=v,g.discardDraft=S,g.copyToDraft=b,g.deletePage=y,g.duplicatePage=P,g.changeUrl=L,g.editMode=!1,g.globalLoadState=new o,g.saveLoadState=new o,g.saveAndPublishLoadState=new o,g.formLoadState=new o(!0),g.versionsLoadState=new o,g.urlLibrary=l,g.versionsQuery=new i({onChanged:w,useHistory:!1,defaultParams:{pageSize:6}}),g.canCreate=d.canCreate("COFPGE"),g.canUpdate=d.canUpdate("COFPGE"),g.canDelete=d.canDelete("COFPGE"),g.canPublishPage=d.hasPermission("COFPGEPAGPUB"),g.canUpdatePageUrl=d.hasPermission("COFPGEUPDURL"),D(g.formLoadState)}]),angular.module("cms.pages").controller("PageListController",["_","shared.entityVersionModalDialogService","shared.LoadState","shared.SearchQuery","shared.pageService","shared.permissionValidationService","pages.pageTemplateService",function(t,a,e,n,o,i,r){var s=this;function l(e){s.isFilterVisible=t.isUndefined(e)?!s.isFilterVisible:e}function u(e){a.publish(e,s.globalLoadState.on).then(c).then(s.globalLoadState.off).catch(s.globalLoadState.off)}function d(){l(!1),c()}function c(){return s.gridLoadState.on(),o.getAll(s.query.getParameters()).then(function(e){s.result=e,s.gridLoadState.off()})}s.publishStatus=[{name:"Unpublished"},{name:"Published"}],r.getAll().then(function(e){s.pageTemplates=e}),s.gridLoadState=new e,s.globalLoadState=new e,s.query=new n({onChanged:d}),s.filter=s.query.getFilters(),s.toggleFilter=l,l(!1),s.publish=u,s.canCreate=i.canCreate("COFPGE"),s.canUpdate=i.canUpdate("COFPGE"),c()}]);