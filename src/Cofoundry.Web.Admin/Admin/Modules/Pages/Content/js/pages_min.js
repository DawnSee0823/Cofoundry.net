angular.module("cms.pages",["ngRoute","cms.shared"]).constant("_",window._).constant("pages.modulePath","/Admin/Modules/Pages/Js/");
angular.module("cms.pages").config(["$routeProvider","shared.routingUtilities","pages.modulePath",function(e,i,a){a=i.mapOptions.bind(null,a);e.when("/new",a("AddPage")).when("/:id",a("PageDetails")).otherwise(a("PageList"))}]);
angular.module("cms.pages").factory("pages.customEntityService",["$http","shared.serviceBase",function(t,e){var r={getAllRoutingRules:function(){return t.get(e+"custom-entity-routing-rules/")}};return r}]);
angular.module("cms.pages").factory("pages.directoryService",["$http","_","shared.serviceBase",function(e,r,t){var a={},c=t+"page-directories";return a.getAll=function(){return e.get(c)},a}]);
angular.module("cms.pages").factory("pages.pageTemplateService",["$http","$q","shared.serviceBase",function(e,r,t){var a={},n=t+"page-templates";return a.getAll=function(){var t=r.defer();return e.get(n).then(function(e){t.resolve(e.items)},t.reject),t.promise},a}]);
angular.module("cms.pages").controller("ChangePageUrlController",["$scope","$q","$location","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(o,t,e,a,n,r,l,i){var u=t.defer(),s=t.defer();function c(){o.submitLoadState.on(),n.updateUrl(o.command).then(l.onSave).then(i).finally(o.submitLoadState.off)}(function(){var e=l.page,t=e.pageRoute;o.isCustomEntityRoute="CustomEntityDetails"===t.pageType,o.page=e,o.command={pageId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId},o.isCustomEntityRoute?o.command.customEntityRoutingRule=t.urlPath:o.command.urlPath=t.urlPath})(),o.submitLoadState=new a,o.formLoadState=new a(!0),o.save=c,o.close=i,o.localesLoaded=u.resolve,o.pageDirectoriesLoaded=s.resolve,o.formLoadState.offWhen(u,s,function(){if(o.isCustomEntityRoute)return r.getAllRoutingRules().then(function(e){o.routingRules=e});var e=t.defer();return e.resolve(),e}())}]);
angular.module("cms.pages").controller("DuplicatePageController",["$scope","$q","$location","shared.stringUtilities","shared.LoadState","shared.pageService","pages.customEntityService","options","close",function(o,t,a,e,i,n,l,r,s){var u=t.defer(),c=t.defer();function d(){o.isCustomEntityRoute||(o.command.urlPath=e.slugify(o.command.title))}function m(){o.submitLoadState.on(),n.duplicate(o.command).then(g).then(s).finally(o.submitLoadState.off)}function g(e){a.path("/"+e)}(function(){var e=r.page,t=e.pageRoute;o.isCustomEntityRoute="CustomEntityDetails"===t.pageType,o.page=e,o.command={pageToDuplicateId:e.pageId,localeId:t.locale?t.locale.localeId:void 0,pageDirectoryId:t.pageDirectory.pageDirectoryId,title:"Copy of "+e.latestVersion.title},o.isCustomEntityRoute?o.command.customEntityRoutingRule=t.urlPath:d()})(),o.submitLoadState=new i,o.formLoadState=new i(!0),o.save=m,o.close=s,o.onTitleChanged=d,o.localesLoaded=u.resolve,o.pageDirectoriesLoaded=c.resolve,o.formLoadState.offWhen(u,c,function(){if(o.isCustomEntityRoute)return l.getAllRoutingRules().then(function(e){o.routingRules=e});var e=t.defer();return e.resolve(),e}())}]);
angular.module("cms.pages").controller("AddPageController",["_","$q","$location","$window","shared.LoadState","shared.stringUtilities","shared.urlLibrary","shared.pageService","pages.pageTemplateService","pages.customEntityService",function(t,e,a,n,o,l,i,d,s,r){var u=this,c=e.defer(),g=e.defer();function f(e,a){var n=e?(u.command.publish=!0,u.saveAndPublishLoadState):u.saveLoadState;e=n,u.globalLoadState.on(),e&&t.isFunction(e.on)&&e.on(),d.add(u.command).then(a).finally(function(e){u.globalLoadState.off(),e&&t.isFunction(e.off)&&e.off()}.bind(null,n))}function p(e){a.path("/"+e)}function h(e){return d.getById(e).then(function(e){n.location.href=i.visualEditorForPage(e.pageRoute,!0)})}function m(){u.command.urlPath=l.slugify(u.command.title)}function v(){var e=u.command.pageType,e="CustomEntityDetails"==e?e:"Generic";u.pageTemplates=t.where(u.allPageTemplates,{pageType:e})}function L(){a.path("/")}u.save=f.bind(null,!1,p),u.saveAndPublish=f.bind(null,!0,p),u.saveAndEdit=f.bind(null,!1,h),u.cancel=L,u.onNameChanged=m,u.onPageTypeChanged=v,u.globalLoadState=new o,u.saveLoadState=new o,u.saveAndPublishLoadState=new o,u.formLoadState=new o(!0),u.onLocalesLoaded=c.resolve,u.onPageDirectoriesLoaded=g.resolve,function(){u.pageTypes=d.getPageTypes(),u.command={showInSiteMap:!0,pageType:u.pageTypes[0].value};var e=s.getAll().then(function(e){u.allPageTemplates=e}),a=r.getAllRoutingRules().then(function(e){u.routingRules=e});u.formLoadState.offWhen(c,g,e,a).then(v)}()}]);
angular.module("cms.pages").controller("PageDetailsController",["$routeParams","$q","$location","_","shared.LoadState","shared.SearchQuery","shared.modalDialogService","shared.entityVersionModalDialogService","shared.urlLibrary","shared.pageService","shared.permissionValidationService","shared.userAreaService","shared.internalModulePath","pages.modulePath",function(t,a,e,n,i,o,s,r,l,u,d,c,p,g){var h=this,f="COFPGE";function m(){h.editMode=!0,h.mainForm.formStatus.clear()}function b(e){e=e?(h.updateDraftCommand.publish=!0,h.saveAndPublishLoadState):h.saveLoadState;B(e),u.update(h.updatePageCommand).then(u.updateDraft.bind(this,h.updateDraftCommand)).then(A.bind(null,"Changes were saved successfully")).finally(G.bind(null,e))}function P(){h.editMode=!1,h.updatePageCommand=E(h.page),h.updateDraftCommand=k(h.page),h.mainForm.formStatus.clear()}function v(){r.publish(h.page.pageId,B).then(A.bind(null,"Page published successfully.")).catch(G)}function S(){r.unpublish(h.page.pageId,B).then(A.bind(null,"The page has been unpublished and reverted to draft state.")).catch(G)}function y(){var e={title:"Discard Version",message:"Are you sure you want to discard this draft? This will discard all changes since the page was last published.",okButtonTitle:"Yes, discard it",onOk:function(){return B(),u.removeDraft(h.page.pageId)}};s.confirm(e).then(A.bind(null,"Draft discarded successfully"))}function D(e){r.copyToDraft(h.page.pageId,e.pageVersionId,h.page.pageRoute.hasDraftVersion,B).then(function(){A("Draft created successfully.")}).catch(G)}function w(){var e={title:"Delete Page",message:"Are you sure you want to delete this page?",okButtonTitle:"Yes, delete it",onOk:function(){return B(),u.remove(h.page.pageId).then(T).catch(G)}};s.confirm(e)}function I(){s.show({templateUrl:g+"Routes/Modals/DuplicatePage.html",controller:"DuplicatePageController",options:{page:h.page}})}function C(){s.show({templateUrl:g+"Routes/Modals/ChangePageUrl.html",controller:"ChangePageUrlController",options:{page:h.page,onSave:A.bind(null,"Url Changed")}})}function L(){s.show({templateUrl:p+"UIComponents/EntityAccess/EntityAccessEditor.html",controller:"EntityAccessEditorController",options:{entityDefinitionCode:f,entityIdPrefix:"page",entityDefinitionName:"Page",entityDescription:h.page.pageRoute.fullPath,entityAccessLoader:function(){return u.getAccessRulesByPageId(h.page.pageId)},saveAccess:u.updateAccessRules}})}function A(e,t){return U(t).then(h.mainForm.formStatus.success.bind(null,e))}function U(e){return a.all([u.getById(t.id).then(function(e){return h.page=e,h.updatePageCommand=E(e),h.updateDraftCommand=k(e),h.editMode=!1,h.isMarkedPublished="Published"==h.page.pageRoute.publishStatus,h.publishStatusLabel=F(e.pageRoute),e}),M(),c.getAll().then(function(e){h.accessRulesEnabled=1<e.length})]).then(function(e){V(e[1])}).then(G.bind(null,e))}function R(){return h.versionsLoadState.on(),M().then(V).then(G.bind(null,h.versionsLoadState))}function M(){return u.getVersionsByPageId(t.id,h.versionsQuery.getParameters())}function V(e){var t=h.page,a=t.pageRoute.isPublished();n.each(e.items,function(e){e.versionLabel=function(e,t){if("Draft"==e.workFlowStatus)return e.workFlowStatus;var a="V"+e.displayVersion;return e.isLatestPublishedVersion?a+" ("+F(t)+")":a}(e,t.pageRoute),e.browseUrl=h.urlLibrary.visualEditorForVersion(t.pageRoute,e,!1,a)}),h.versions=e}function F(e){return"Published"==e.publishStatus&&e.publishDate<Date.now()?"Pending Publish":e.publishStatus}function E(e){return{pageId:e.pageId,tags:e.tags}}function k(e){var t=e.latestVersion,a=t.openGraph;return{pageId:e.pageId,title:t.title,metaDescription:t.metaDescription,openGraphTitle:a.title,openGraphDescription:a.description,openGraphImageId:a.image?a.image.ImageAssetId:void 0,showInSiteMap:t.showInSiteMap}}function T(){e.path("")}function B(e){h.globalLoadState.on(),e&&n.isFunction(e.on)&&e.on()}function G(e){h.globalLoadState.off(),e&&n.isFunction(e.off)&&e.off()}h.edit=m,h.save=b.bind(null,!1),h.saveAndPublish=b.bind(null,!0),h.cancel=P,h.publish=v,h.unpublish=S,h.discardDraft=y,h.copyToDraft=D,h.deletePage=w,h.duplicatePage=I,h.changeUrl=C,h.viewAccessRules=L,h.editMode=!1,h.globalLoadState=new i,h.saveLoadState=new i,h.saveAndPublishLoadState=new i,h.formLoadState=new i(!0),h.versionsLoadState=new i,h.urlLibrary=l,h.versionsQuery=new o({onChanged:R,useHistory:!1,defaultParams:{pageSize:6}}),h.canCreate=d.canCreate(f),h.canUpdate=d.canUpdate(f),h.canDelete=d.canDelete(f),h.canPublishPage=d.hasPermission(f+"PAGPUB"),h.canUpdatePageUrl=d.hasPermission(f+"UPDURL"),U(h.formLoadState)}]);
angular.module("cms.pages").controller("PageListController",["_","shared.entityVersionModalDialogService","shared.LoadState","shared.SearchQuery","shared.pageService","shared.permissionValidationService","pages.pageTemplateService",function(a,t,e,n,i,l,r){var o=this;function s(e){o.isFilterVisible=a.isUndefined(e)?!o.isFilterVisible:e}function d(e){t.publish(e,o.globalLoadState.on).then(u).then(o.globalLoadState.off).catch(o.globalLoadState.off)}function g(){s(!1),u()}function u(){return o.gridLoadState.on(),i.getAll(o.query.getParameters()).then(function(e){o.result=e,o.gridLoadState.off()})}o.publishStatus=[{name:"Unpublished"},{name:"Published"}],r.getAll().then(function(e){o.pageTemplates=e}),o.gridLoadState=new e,o.globalLoadState=new e,o.query=new n({onChanged:g}),o.filter=o.query.getFilters(),o.toggleFilter=s,s(!1),o.publish=d,o.canCreate=l.canCreate("COFPGE"),o.canUpdate=l.canUpdate("COFPGE"),u()}]);